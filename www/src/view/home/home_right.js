// Generated by CoffeeScript 2.6.1
var Box, Thread, homeData, m;

m = require("mithril");

// data
homeData = require("./home_data");

// common
Box = require("../common/box");

// component
Thread = require("./home_thread");

module.exports = {
  oninit: async function(v) {
    var err, timer, tmp;
    // 如果提供了帖子pid
    if (v.attrs.pid) {
      return (await homeData.getOne(v.attrs.pid));
    // 如果提供了关键词
    } else if (v.attrs.word) {
      try {
        tmp = (await m.request({
          method: "get",
          url: `/api/posts/ser?search=${v.attrs.word}`
        }));
        if (!tmp.valid) {
          return Notice({
            msg: tmp.valid
          });
        }
        return homeData.posts["0"] = tmp.data;
      } catch (error) {
        err = error;
        return console.log(err);
      }
    } else {
      // 否则首页
      await homeData.fresh(0, true, v.state.data.clickCount, v.state);
      if (timer) {
        clearInterval(timer);
      }
      return timer = setInterval(async function() {
        if (v.attrs.pid) {
          return (await homeData.fresh(0, true, v.state.data.clickCount, v.state));
        }
      }, 5 * 60 * 1000);
    }
  },
  data: {
    allCount: 0,
    clickCount: 5
  },
  view: function(v) {
    var _this, item;
    _this = this;
    return m("", {
      style: {
        flex: 4,
        width: "100%"
      }
    }, [
      (function() {
        var i,
      len,
      ref,
      results;
        ref = homeData.posts["0"];
        // 左右分栏
        //maxWidth:"73.3rem"
        results = [];
        for (i = 0, len = ref.length; i < len; i++) {
          item = ref[i];
          results.push(m(Thread,
      {
            key: item.pid,
            self: item,
            pid: v.attrs.pid,
            word: v.attrs.word
          }));
        }
        return results;
      })(),
      // 加载更多
      !v.attrs.pid ? m(Box,
      {
        color: "yellow",
        isBlock: true,
        isBtn: true,
        onclick: async function() {
          var timer;
          if (_this.data.allCount > _this.data.clickCount) {
            return (await homeData.fresh(0,
      true,
      _this.data.clickCount += 5,
      _this));
          } else {
            if (timer) {
              clearInterval(timer);
            }
            return timer = setInterval(function() {
              if (document.querySelector("html").scrollTop > 0) {
                return document.querySelector("html").scrollTop -= (document.body.clientHeight - document.querySelector("html").scrollTop) / 100;
              } else {
                return clearInterval(timer);
              }
            },
      10);
          }
        }
      },
      _this.data.allCount > _this.data.clickCount ? "加载更多" : "到底啦，点击返回顶部") : void 0
    ]);
  }
};
